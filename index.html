<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>G-game</title>
  </head>
  <style media="screen">
  .offline {
    transition: -webkit-filter 1.5s cubic-bezier(0.65, 0.05, 0.36, 1),
    background-color 1.5s cubic-bezier(0.65, 0.05, 0.36, 1);
    will-change: -webkit-filter, background-color;
  }
  .offline.inverted {
    -webkit-filter: invert(100%);
    background-color: #000;
  }
  </style>
  <body>
    <div id="game" class="offline" style="background-color:#fff;">
    </div>
    <img src="image/image.png" id="img" style="display:none" />
  </body>
  <script type="text/javascript">

  var canvas = document.createElement('canvas');
  var a = document.getElementById('game');
  canvas.id = 'cv';
  canvas.width = 600;
  canvas.height = 300;
  a.appendChild(canvas);

  var canvas = document.getElementById('cv');
  var canvasCtx  = canvas.getContext('2d');
  var spriteDefinition = {
    CACTUS_LARGE:{x: 332, y: 2},  //å¤§ä»™äººæŒ ğŸŒµ
    CACTUS_SMALL:{x: 228, y: 2},  //å°ä»™äººæŒ ğŸŒµ
    CLOUD: {x: 86, y: 2},         //äº‘ â›…ï¸
    HORIZON: {x: 2, y: 54},       //åœ°é¢
    MOON: {x: 484, y: 2},         //æœˆäº® ğŸŒ›
    PTERODACTYL: {x: 134, y: 2},    //ç¿¼é¾™
    RESTRAT: {x: 2, y: 2},          //é‡æ–°å¼€å§‹æŒ‰é’®
    TEXT_SPRITE: {x: 655, y: 2} ,   //åˆ†æ•°
    TREX:{x: 848, y: 2},            //éœ¸ç‹é¾™
    STAR:{x: 645, y: 2},            //æ˜Ÿæ˜Ÿ
  };
  var FPS = 60;
  var gameFrame = 0;
  var DEFAULT_WIDTH = 600;
  var c = document.getElementById('cv');
  var canvasCtx = c.getContext('2d');
  var imgSprite = document.getElementById('img')

  /*********
  * äº”ä¸ªæ„é€ å‡½æ•°ï¼š
  * 1ã€æ¸¸æˆé€»è¾‘ç®¡ç†å‡½æ•° Runner
  * 2ã€èƒŒæ™¯ç®¡ç†å‡½æ•° Horizon
  *    a.åœ°é¢ HorizonLine
  *    b.äº‘æœµ cloud
  *    c.æ˜¼å¤œäº¤æ›¿ NightMode
  *    d.éšœç¢ç‰© Obstacle
  * 3ã€æé¾™å‡½æ•° Trex
  * 4ã€åˆ†æ•°è®°å½•å‡½æ•° DistanceMeter
  * 5ã€æ¸¸æˆç»“æŸæ“ä½œé¢æ¿å‡½æ•° GameOverPanel
  ************/

  //***************************************************************************
  // HorizonLine

  // åœ°é¢çš„ç»˜åˆ¶
    HorizonLine.dimensions = {
      WIDTH:600,	//å®½600
      HEIGHT:12,	//é«˜12åƒç´ 
      YPOS:127	//åœ¨ç”»å¸ƒä¸­çš„ä½ç½®
    };

    /**
    * canvas åœ°é¢å°†ç»˜åˆ¶åœ¨æ­¤ç”»å¸ƒä¸Š
    * spritePos åœ°é¢åœ¨é›ªç¢§å›¾ä¸­çš„åæ ‡
    */
    function HorizonLine(canvas, spritePos) {
      this.spritePos = spritePos;
      this.canvas = canvas;
      this.canvasCtx = canvas.getContext('2d');
      // this.sourceDimensions = {};
      this.dimensions = HorizonLine.dimensions;
      // åœ¨é›ªç¢§å›¾ä¸­åæ ‡ä¸º2å’Œ602å¤„åˆ†åˆ«ä¸ºä¸åŒçš„åœ°å½¢
      this.sourceXPos = [this.spritePos.x,this.spritePos.x + this.dimensions.WIDTH];
      this.xPos = []; // åœ°é¢åœ¨ç”»å¸ƒçš„xåæ ‡
      this.yPos = 0;  // åœ°é¢åœ¨ç”»å¸ƒçš„yåæ ‡
      this.bumpThreshold = 0.5 // éšæœºåœ°å½¢ç³»æ•°

      this.setSourceDimensions()
      this.draw()
    }

    // HorizonLineåŸå‹é“¾ä¸­çš„æ–¹æ³•
    HorizonLine.prototype = {
      /** è®¾ç½®åœ°é¢ */
      setSourceDimensions: function() {
       /*for (var dimension in HorizonLine.dimensions) {
          if (IS_HIDPI) {
            if (dimension != 'YPOS') {
              this.sourceDimensions[dimension] * 2;
            }
          } else {
            this.sourceDimensions[dimension] = HorizonLine.dimensions[dimension];
          }
          this.dimensions[dimension] = HorizonLine.dimensions[dimension];
        }*/
        this.xPos = [0, this.dimensions.WIDTH]; // 0, 600
        this.yPos = HorizonLine.dimensions.YPOS;
        },
        // éšæœºåœ°å½¢
        getRandomType:function() {
          return Math.random() > this.bumpThreshold ? this.dimensions.WIDTH : 0;
        },

        draw:function() {
          // ä½¿ç”¨9ä¸ªå‚æ•°çš„ drawImage æ–¹æ³•
          this.canvasCtx.drawImage(imgSprite,
              this.sourceXPos[0], this.spritePos.y,
              this.dimensions.WIDTH, this.dimensions.HEIGHT,
              this.xPos[0],this.yPos,
              this.dimensions.WIDTH,this.dimensions.HEIGHT);

          this.canvasCtx.drawImage(imgSprite,
              this.sourceXPos[1], this.spritePos.y,
              this.dimensions.WIDTH, this.dimensions.HEIGHT,
              this.xPos[1],this.yPos,
              this.dimensions.WIDTH,this.dimensions.HEIGHT);
        },

        // æ›´æ–° x ä½ç½®
        updateXPos:function(pos, increment) {
          var line1 = pos;
          var line2 = pos === 0 ? 1 : 0;

          this.xPos[line1] -= increment;
          this.xPos[line2] = this.xPos[line1] + this.dimensions.WIDTH;

          // è‹¥ç¬¬ä¸€æ®µåœ°é¢å®Œå…¨ç§»é™¤ cancas å¤–
          if (this.xPos[line1] <= -this.dimensions.WIDTH) {
            //å°†å…¶ç§»è‡³ canvas å¤–å³ä¾§
            this.xPos[line1] += this.dimensions.WIDTH * 2;
            // åŒæ—¶å°†ç¬¬äºŒæ®µè·¯é¢ç§»åˆ° canvas å†…
            this.xPos[line2] = this.xPos[line1] - this.dimensions.WIDTH;
            // é€‰æ‹©éšæœºåœ°å½¢
            this.sourceXPos[line1] = this.getRandomType() + this.spritePos.x;
          }
        },

        /*
        * æ›´æ–°åœ°é¢
        * @param {number} deltaTime
        * @param {number} speed
        */
        update:function(deltaTime, speed) {
          var increment = Math.floor(speed * (FPS / 1000) * deltaTime);
          if (this.xPos[0] <= 0) {
            this.updateXPos(0, increment);
          } else {
            this.updateXPos(1, increment);
          }
          this.draw();
        },

        // å°†åœ°é¢å¤ä½åˆ°èµ·å§‹ä½ç½®
        reset:function() {
          this.xPos[0] = 0;
          this.xPos[1] = this.dimensions.WIDTH;
        }
      };

    //*********************************************************
    // Cloud


    function getRandomNum(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function getTimeStamp() {
      return performance.now();
    }


    /**
    * Cloud background item.
    * éšœç¢ç‰©ï¼Œæ²¡æœ‰ç¢°æ’
    * spritePos é›ªç¢§å›¾çš„åæ ‡
    * containerWidth å®¹å™¨å®½åº¦
    */
    function Cloud(canvas, spritePos, containerWidth) {
      this.canvas = canvas;
      this.canvasCtx = canvas.getContext('2d');
      this.spritePos = spritePos;
      this.containerWidth = containerWidth;
      this.xPos = containerWidth; // äº‘åˆå§‹xåæ ‡åœ¨å±å¹•å¤–
      this.yPos = 0; // åˆå§‹é«˜åº¦
      this.remove = false; // æ˜¯å¦ç§»åŠ¨
      // äº‘ä¹‹é—´çš„é—´éš”400~100
      this.cloudGap = getRandomNum(Cloud.config.MIN_CLOUD_GAP,Cloud.config.MAX_CLOUD_GAP);
      this.init();
    }
    /**
    * äº‘å¯¹è±¡
    */
    Cloud.config = {
      HEIGHT: 13,         //äº‘spriteçš„é«˜åº¦
      MAX_CLOUD_GAP: 400, //äº‘ä¹‹é—´æœ€å¤§é—´éš™
      MAX_SKY_LEVEL: 30,  //äº‘çš„æœ€å¤§é«˜åº¦
      MIN_CLOUD_GAP: 100, //äº‘ä¹‹é—´æœ€å°é—´éš™
      MIN_SKY_LEVEL: 71,  //äº‘æœ€å°é«˜åº¦
      WIDTH: 46,          //äº‘spriteçš„å®½åº¦
      MAX_CLOUDS: 6,      //æœ€å¤§æ•°é‡
      CLOUD_FREQUENCY: 5, //äº‘å‡ºç°é¢‘ç‡
    }
    //å­˜å‚¨äº‘
    Cloud.clouds = [];

    //åŸå‹é“¾
    Cloud.prototype = {
      // é¢„ç½®
      init: function() {
        this.yPos = getRandomNum(Cloud.config.MAX_SKY_LEVEL,Cloud.config.MIN_SKY_LEVEL);
        this.draw();
      },

      // Draw the cloud
      draw: function() {
        this.canvasCtx.save();
        var sourceWidth = Cloud.config.WIDTH;
        var sourceHeight = Cloud.config.HEIGHT;

        this.canvasCtx.drawImage(imgSprite,
            this.spritePos.x,this.spritePos.y,
            sourceWidth,sourceHeight,
            this.xPos,this.yPos,
            sourceWidth,sourceHeight);
        this.canvasCtx.restore();
      },

      // æ·»åŠ äº‘å¹¶æ§åˆ¶å…¶è¿åŠ¨
      updateClouds:function(speed) {
        var numClouds = Cloud.clouds.length;
        if (numClouds) {
          for (var i = numClouds - 1; i >= 0; i--) {
            Cloud.clouds[i].update(speed);
          }

          var lastCloud = Cloud.clouds[numClouds - 1];
          // å¦‚æœå½“å‰å­˜åœ¨çš„äº‘æœµæ•°é‡å°äºæœ€å¤§äº‘æ•°é‡ï¼Œå¹¶ä¸”äº‘ä½ç½®å¤§äºé—´éš™æ—¶ï¼Œéšæœºæ·»åŠ äº‘
          if (numClouds < Cloud.config.MAX_CLOUDS && (DEFAULT_WIDTH - lastCloud.xPos) > lastCloud.cloudGap
          && Cloud.config.CLOUD_FREQUENCY > Math.random()) {
            this.addCloud();
          }
          Cloud.clouds = Cloud.clouds.filter(function(obj) {
            return !obj.remove;
          });
        } else {
          this.addCloud();
        }
      },
      update:function(speed) {
        if (!this.remove) {
          // å‘å·¦ç§»åŠ¨
          this.xPos -= Math.ceil(speed);
          this.draw();

          if (!this.isVisible()) {
            this.remove = true;
          }
        }
      },

      // åˆ¤æ–­äº‘æ˜¯å¦ç§»å‡ºå±å¹•å¤–
      isVisible:function() {
        return this.xPos + Cloud.config.WIDTH > 0;
      },
      // å°†äº‘æ·»åŠ åˆ°æ•°ç»„
      addCloud:function() {
        var cloud = new Cloud(this.canvas, spriteDefinition.CLOUD,DEFAULT_WIDTH);
        Cloud.clouds.push(cloud);
      }
    };

    //********************************************************
    // æ˜¼å¤œäº¤æ›¿
    NightMode.config = {
      FADE_SPEED: 0.035,  //æ·¡å…¥æ·¡å‡ºé€Ÿåº¦
      HEIGHT: 40,         //ğŸŒ›é«˜åº¦
      MOON_SPEED: 0.25,   // æœˆäº®ç§»åŠ¨é€Ÿåº¦
      NUM_STARS: 2,       // æ˜Ÿæ˜Ÿæ•°é‡
      STAR_SIZE: 9,       // æ˜Ÿæ˜Ÿå®½åº¦
      STAR_MAX_Y: 70,     // æ˜Ÿæ˜Ÿåœ¨ç”»å¸ƒä¸Šå‡ºç°çš„ä½ç½®
      WIDTH: 20,          //åŠä¸ªæœˆäº®
    }

    // æœˆäº®åœ¨ä¸åŒæ—¶æœŸæœ‰ä¸åŒçš„ä½ç½®
    NightMode.phases = [140, 120, 100, 60, 40, 20, 0];
    // æ—¶é—´è®°å½•
    NightMode.invertTimer = 0;
    // æ˜¯å¦å¯ä»¥è¿›è¡Œæ˜¼å¤œäº¤æ›¿
    NightMode.inverted = false;
    // ç”¨äºæ§åˆ¶æ ·å¼åˆ‡æ¢
    NightMode.inverTrigger = false;
    // é»‘å¤œæŒç»­æ—¶é—´
    NightMode.INVERT_FADE_DURATION = 5000;

    function NightMode(canvas, spritePos, containerWidth) {
      this.spritePos = spritePos;
      this.canvas = canvas;
      this.canvasCtx = canvas.getContext("2d");
      this.containerWidth = containerWidth;
      this.xPos = containerWidth - 50;    //æœˆäº®çš„xåæ ‡
      this.yPos = 30;                     //æœˆäº®çš„yåæ ‡
      this.currentPhase = 0;
      this.opacity = 0;
      this.stars = [];                    //ç”¨äºå­˜å‚¨æ˜Ÿæ˜Ÿ
      this.drawStars = false;             //æ˜¯å¦ç»˜åˆ¶æ˜Ÿæ˜Ÿ
      this.placeStars();                  //æ”¾ç½®æ˜Ÿæ˜Ÿ
    }

    NightMode.prototype = {
      update:function(activated) {
        //å¦‚æœå¤œæ™šæ¨¡å¼å¤„äºæ¿€æ´»çŠ¶æ€ä¸”opacityä¸º0æ—¶ï¼Œå¯¹æœˆäº®å‘¨æœŸè¿›è¡Œæ›´æ–°
        if(activated && this.opacity == 0) {
          this.currentPhase++;
          if(this.currentPhase >= NightMode.phases.length) {
            this.currentPhase = 0;
          }
        }

        //æ·¡å…¥
        if(activated && (this.opacity < 1 || this.opacity == 0)) {
          this.opacity += NightMode.config.FADE_SPEED;
        } else if (this.opacity > 0) {
          //æ·¡å‡º
          this.opacity -= NightMode.config.FADE_SPEED;
        }
        // å½“opacityå¤§äº0æ—¶ï¼Œç§»åŠ¨æœˆäº®ä½ç½®
        if (this.opacity > 0) {
          this.xPos = this.updateXPos(this.xPos, NightMode.config.MOON_SPEED);
          //ç§»åŠ¨æ˜Ÿæ˜Ÿ
          if (this.drawStars) {
            for (var i = 0; i < NightMode.config.NUM_STARS; i++) {
              this.stars[i].x = this.updateXPos(this.stars[i].x,NightMode.config.STAR_SPEED);
            }
          }
          this.draw();
        } else {
          this.opacity = 0;
          this.placeStars();
        }
        this.drawStars = true;
      },
      updateXPos:function(currentPos, speed) {
        if (currentPos < -NightMode.config.WIDTH) {
          currentPos = this.containerWidth;
        } else {
          currentPos -= speed;
        }
        return currentPos;
      },
      draw:function() {
        // å‘¨æœŸä¸º3æ—¶ç”»æ»¡æœˆ
        var moonSourceWidth = this.currentPhase == 3 ? NightMode.config.WIDTH * 2 : NightMode.config.WIDTH;
        var moonSourceHeight = NightMode.config.HEIGHT;
        //ä»é›ªç¢§å›¾ä¸Šè·å–æœˆäº®çš„å½¢çŠ¶
        var moonSourceX = this.spritePos.x + NightMode.phases[this.currentPhase];
        var moonOutputWidth = moonSourceWidth;
        var starSize = NightMode.config.STAR_SIZE;
        var starSourceX = spriteDefinition.STAR.x;

        this.canvasCtx.save();
        this.canvasCtx.globalAlpha = this.opacity;

        if (this.drawStars) {
          for (var i = 0; i < NightMode.config.NUM_STARS; i++) {
            this.canvasCtx.drawImage(imgSprite,
              starSourceX, this.stars[i].sourceY,
              starSize, starSize,
              Math.round(this.stars[i].x), this.stars[i].y,
              NightMode.config.STAR_SIZE, NightMode.config.STAR_SIZE);
          }
        }
        this.canvasCtx.drawImage(imgSprite,
          moonSourceX, this.spritePos.y,
          moonSourceWidth, moonSourceHeight,
          Math.round(this.xPos), this.yPos,
          moonOutputWidth, NightMode.config.HEIGHT);
          
        this.canvasCtx.globalAlpha = 1;
        this.canvasCtx.restore();
      },
      placeStars:function() {
        //å°†ç”»å¸ƒåˆ†ç»„
        var segmentSize = Math.round(this.containerWidth /NightMode.config.NUM_STARS);
        for (var i = 0; i < NightMode.config.NUM_STARS; i++) {
          this.stars[i] = {};
          // æ¯ç»„æ˜Ÿæ˜Ÿçš„éšæœºä½ç½®
          this.stars[i].x = getRandomNum(segmentSize * i, segmentSize * (i + 1));
          this.stars[i].y = getRandomNum(0, NightMode.config.STAR_MAX_Y);
          this.stars[i].sourceY = spriteDefinition.STAR.y + NightMode.config.STAR_SIZE * i;
        }
      },
      invert:function(deltaTime) {
        this.update(NightMode.inverted);
        // é»‘å¤œæ—¶é—´æŒç»­5ç§’
        if(NightMode.invertTimer > NightMode.INVERT_FADE_DURATION) {
          NightMode.invertTimer = 0;
          NightMode.invertTrigger = false;
          NightMode.inverted = a.classList.toggle('inverted',NightMode.invertTrigger);
        } else if(NightMode.invertTimer) {
          NightMode.invertTimer += deltaTime;
        } else {
          // æ¯500å¸§è§¦å‘é»‘å¤œï¼Œï¼ˆå®Œæ•´æ¸¸æˆæ˜¯æ¯700ç±³è§¦å‘ä¸€æ¬¡é»‘å¤œï¼‰
          NightMode.invertTrigger = !(gameFrame % 500);
          if(NightMode.invertTrigger && NightMode.invertTimer === 0) {
            NightMode.invertTimer += deltaTime;
            NightMode.inverted = a.classList.toggle('inverted',NightMode.invertTrigger);
          }
        }
      },
      reset:function() {
        this.currentPhase = 0;
        this.opacity = 0;
        this.update(false);
      }
    }


    window.onload = function() {
      var h = new HorizonLine(c, spriteDefinition.HORIZON);
      var cloud = new Cloud(c,spriteDefinition.CLOUD,DEFAULT_WIDTH);
      var night = new NightMode(c,spriteDefinition.MOON,DEFAULT_WIDTH);
      var startTime = 0;
      var deltaTime;
      (function draw(time) {
        gameFrame++;
        canvasCtx.clearRect(0,0,600,150);
        time = time || 0;
        deltaTime = time - startTime;
        h.update(deltaTime,3);
        cloud.updateClouds(0.2);
        night.invert(deltaTime);
        startTime = time;
        window.requestAnimationFrame(draw,c);
      })();
    };
  </script>
</html>
